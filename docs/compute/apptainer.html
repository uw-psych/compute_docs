<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.0">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="The Apptainer container environment">

<title>apptainer – UW Psychology Computational Resources</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../docs/software/index.html" rel="next">
<link href="../../docs/compute/lmod.html" rel="prev">
<link href="../../_static/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/popover-glossary/popover-glossary.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../_static/lib/asciinema-player.css">
</head>

<body class="nav-sidebar docked fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../docs/compute/index.html">Using the cluster</a></li><li class="breadcrumb-item"><a href="../../docs/compute/apptainer.html">Apptainer</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../_static/department_uw_wordmark.svg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Computational Resources</a> 
        <div class="sidebar-tools-main">
    <div id="quarto-search" class="quarto-navigation-tool px-1" title="Search"></div>
</div>
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../docs/start/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/start/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to UW Hyak</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/start/connect-ssh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Connecting to Hyak with SSH</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/start/hyakvnc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">hyakvnc</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../docs/compute/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using the cluster</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/compute/slurm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SLURM basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/compute/lmod.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lmod</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/compute/apptainer.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Apptainer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../docs/software/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Software</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/software/afni.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AFNI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/software/conn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CONN Toolbox</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/software/freesurfer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FreeSurfer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/software/matlab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MATLAB</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/software/spm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SPM Toolbox</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Utilities</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/software/utilities/gdu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gdu</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../docs/storage/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Storage</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/storage/concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concepts and terminology</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/storage/options.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Storage options</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/storage/klone-storage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Storage on Klone</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://mailman11.u.washington.edu/mailman/listinfo/psych-hpc" class="sidebar-item-text sidebar-link">
 <span class="menu-text">psych-hpc mailing list</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/CONTRIBUTING.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributing</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="apptainer" class="level1">
<h1>Apptainer</h1>
<p>Apptainer (formerly Singularity) is a simple container platform enabling users to install and run software that would otherwise be unsupported by the host environment.</p>
<p>On Klone, the <code>apptainer</code> command is available on all <a class="glossary-ref" data-glossary-term="compute node" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2NvbXB1dGUgbm9kZScgcm9sZT0ndG9vbHRpcCc+QQoKbm9kZQoKb24KCnRoZQoKS2xvbmUKCmNsdXN0ZXIKCnRoYXQKCmlzCgp1c2VkCgpmb3IKCnJ1bm5pbmcKCmpvYnMuCgpTZWUKCjxhIGhyZWY9Ii9jb21wdXRlX2RvY3MvZG9jcy9jb21wdXRlL3NsdXJtLmh0bWwiPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">compute nodes</a>, but it is not available on the <a class="glossary-ref" data-glossary-term="login node" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2xvZ2luIG5vZGUnIHJvbGU9J3Rvb2x0aXAnPkEKCm5vZGUKCm9uCgp0aGUKCktsb25lCgpjbHVzdGVyCgp0aGF0CgppcwoKdXNlZAoKZm9yCgpsb2dnaW5nCgppbgoKYW5kCgpzdWJtaXR0aW5nCgpqb2JzLgoKU2VlCgo8YSBocmVmPSIvY29tcHV0ZV9kb2NzL2RvY3MvY29tcHV0ZS9zbHVybS5odG1sIj5oZXJlPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">login node</a>.</p>
<p>By default, the <code>apptainer</code> command will use the system version of Apptainer:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> apptainer <span class="co"># prints /usr/bin/apptainer</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> <span class="at">--version</span> <span class="co"># apptainer version 1.2.4-1.el8 (as of 2023-12-05)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled" title="Loading a different version of Apptainer using Lmod">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loading a different version of Apptainer using Lmod
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>To use a different version of Apptainer, load the appropriate <a href="../../docs/compute/lmod.html"></a><a class="glossary-ref" data-glossary-term="lmod" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2xtb2QnIHJvbGU9J3Rvb2x0aXAnPkFuCgplbnZpcm9ubWVudAoKbW9kdWxlCgpzeXN0ZW0KCnRoYXQKCmlzCgp1c2VkCgp0bwoKbG9hZAoKYWRkaXRpb25hbAoKc29mdHdhcmUKCm9uCgpLbG9uZQoKY29tcHV0ZQoKbm9kZXMuCgpTZWUKCjxhIGhyZWY9Ii9jb21wdXRlX2RvY3MvZG9jcy9jb21wdXRlL2xtb2QuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">Lmod</a> module. For example, to use Apptainer version 1.1.5:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load apptainer/1.1.5</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> apptainer <span class="co"># prints /sw/apptainer/1.1.5/bin/apptainer</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> <span class="at">--version</span> <span class="co"># apptainer version 1.1.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To see all available versions of Apptainer, run:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> <span class="at">-t</span> spider apptainer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The default module is indicated by the tag <code>(D)</code> following the version. For example, <code>apptainer/local (D)</code> indicates that the default version is <code>local</code>. (The local version is the version installed on the system.)</p>
</div>
</div>
</div>
<section id="using-apptainer" class="level2">
<h2 class="anchored" data-anchor-id="using-apptainer">Using Apptainer</h2>
<section id="interactive-session" class="level3">
<h3 class="anchored" data-anchor-id="interactive-session">Interactive session</h3>
<section id="bind-paths" class="level4">
<h4 class="anchored" data-anchor-id="bind-paths">Bind paths</h4>
<p><a class="glossary-ref" data-glossary-term="apptainer" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2FwcHRhaW5lcicgcm9sZT0ndG9vbHRpcCc+QQoKc29mdHdhcmUKCmNvbnRhaW5lcgoKcGxhdGZvcm0KCnRoYXQKCmlzCgp1c2VkCgp0bwoKcnVuCgpzb2Z0d2FyZQoKb24KCnRoZQoKS2xvbmUKCmNsdXN0ZXIuCgpTZWUKCjxhIGhyZWY9Ii9jb21wdXRlX2RvY3MvZG9jcy9jb21wdXRlL2FwcHRhaW5lci5odG1sIj5oZXJlPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">Apptainer</a> containers are designed to be portable, so by default, they do not have access to all the files on the host system. To make files available to the container, you must bind them to the container. This is done using the <code>--bind</code> option of the <code>apptainer</code> command or the <code>APPTAINER_BINDPATH</code> <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variable</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Default bind paths">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Default bind paths
</div>
</div>
<div class="callout-body-container callout-body">
<p>By default, <code>apptainer</code> will make several directories available within the container by binding them to the same path in the container so that <code>/somefolder</code> on the host is available as <code>/somefolder</code> within the container.</p>
<p>These directories include:</p>
<ul>
<li><code>$HOME</code> (your home directory, a.k.a. <code>~</code>)</li>
<li><code>/tmp</code> (temporary directory – unique to each node; contents are purged when the users’ last job running on the node completes)</li>
<li><code>$PWD</code> (the current working directory, i.e., the directory you are in when you run <code>apptainer</code>)</li>
</ul>
<p>The Klone Apptainer installation is also configured to bind several other directories to the same path in the container, including:</p>
<ul>
<li><code>/mmfs1</code> (the main filesystem)</li>
<li><code>/scr</code> (the scratch filesystem, same as <code>/tmp</code>)</li>
</ul>
</div>
</div>
<p>We recommend setting the following binds before running a container:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">APPTAINER_BINDPATH</span><span class="op">=</span><span class="st">"/gscratch"</span> <span class="co"># Make /gscratch available within the container</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To start an Apptainer container interactively, run the following:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> shell <span class="op">&lt;</span>path_to_container<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="pulling-an-apptainer-image-from-docker.io-registry" class="level2">
<h2 class="anchored" data-anchor-id="pulling-an-apptainer-image-from-docker.io-registry">Pulling an Apptainer image from docker.io registry</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> pull docker://<span class="op">&lt;</span>image_name<span class="op">&gt;</span>[:<span class="op">&lt;</span>tag<span class="op">&gt;</span>] <span class="co"># Pulls the image from docker registry</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="practical-examples" class="level2">
<h2 class="anchored" data-anchor-id="practical-examples">Practical examples</h2>
<section id="using-apptainer-to-run-a-python-script" class="level3">
<h3 class="anchored" data-anchor-id="using-apptainer-to-run-a-python-script">Using Apptainer to run a Python script</h3>
<p>Let’s try running a Python script using Apptainer. The <a href="https://docs.python.org/3/whatsnew/3.11.html#summary-release-highlights">release notes</a> for Python version 3.11 say that it is “between 10-60% faster than Python 3.10”. Is this true? Let’s find out! We’ll write a simple Python script to test this and use Apptainer to run it on Python 3.10 and Python 3.11.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>speedtest.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-5" data-filename="speedtest.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, sys, timeit</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-4"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values of the environment variables M and N, or use default values:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-5" class="code-annotation-target"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">int</span>(os.getenv(<span class="st">"N"</span>, default<span class="op">=</span><span class="dv">1000</span>))  <span class="co"># How many numbers to join</span></span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="bu">int</span>(os.getenv(<span class="st">"M"</span>, default<span class="op">=</span><span class="dv">100</span>))  <span class="co"># How many times to run the test</span></span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-8"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to test:</span></span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> join_nums():</span>
<span id="annotated-cell-5-10"><a href="#annotated-cell-5-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"-"</span>.join([<span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)])</span>
<span id="annotated-cell-5-11"><a href="#annotated-cell-5-11" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2">2</button><span id="annotated-cell-5-12" class="code-annotation-target"><a href="#annotated-cell-5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Print details about the test to stderr:</span></span>
<span id="annotated-cell-5-13"><a href="#annotated-cell-5-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="annotated-cell-5-14"><a href="#annotated-cell-5-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Running join_nums() </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">*</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss"> times on Python v</span><span class="sc">{</span>sys<span class="sc">.</span>version_info<span class="sc">.</span>major<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>sys<span class="sc">.</span>version_info<span class="sc">.</span>minor<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="annotated-cell-5-15"><a href="#annotated-cell-5-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span><span class="op">=</span>sys.stderr,</span>
<span id="annotated-cell-5-16"><a href="#annotated-cell-5-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-5-17"><a href="#annotated-cell-5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-18"><a href="#annotated-cell-5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the test:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3">3</button><span id="annotated-cell-5-19" class="code-annotation-target"><a href="#annotated-cell-5-19" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> timeit.timeit(join_nums, number<span class="op">=</span>m)</span>
<span id="annotated-cell-5-20"><a href="#annotated-cell-5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-21"><a href="#annotated-cell-5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the result:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="4">4</button><span id="annotated-cell-5-22" class="code-annotation-target"><a href="#annotated-cell-5-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="5,6" data-code-annotation="1">The <code>os.getenv</code> function retrieves the value of an <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variable</a> or returns a default value if the variable is not set.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="12,15" data-code-annotation="2">Here, we use the <code>file</code> parameter to <code>print()</code>, which makes it write to the <a class="glossary-ref" data-glossary-term="stderr" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZGVycicgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKZXJyb3IKCnN0cmVhbSwKCjxjb2RlPnN0ZGVycjwvY29kZT4KLAoKaXMKCndoZXJlCgphCgpwcm9ncmFt4oCZcwoKZXJyb3IKCmFuZAoKZGlhZ25vc3RpYwoKbWVzc2FnZXMKCmFyZQoKd3JpdHRlbgoKdG8KCmJ5CgpkZWZhdWx0LgoKU2VlCgo8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TdGFuZGFyZF9zdHJlYW1zIj5oZXJlPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">standard error</a> stream (<code>stderr</code>) instead of the default <a class="glossary-ref" data-glossary-term="stdout" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZG91dCcgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKb3V0cHV0CgpzdHJlYW0sCgo8Y29kZT5zdGRvdXQ8L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCm91dHB1dAoKaXMKCndyaXR0ZW4KCnRvCgpieQoKZGVmYXVsdC4KClNlZQoKPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhbmRhcmRfc3RyZWFtcyI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">standard output</a> stream (<code>stdout</code>). This is useful because we want to print the result of the test to <code>stdout</code> so that we can save the output by redirecting it to a file, but we also want to print some information about the test to <code>stderr</code> so that it doesn’t get mixed up with the result.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="19" data-code-annotation="3"><code>timeit.timeit()</code> runs a function multiple times and returns the average time it took to run the function.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="22" data-code-annotation="4">The <code>print</code> function prints to the <a class="glossary-ref" data-glossary-term="stdout" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZG91dCcgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKb3V0cHV0CgpzdHJlYW0sCgo8Y29kZT5zdGRvdXQ8L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCm91dHB1dAoKaXMKCndyaXR0ZW4KCnRvCgpieQoKZGVmYXVsdC4KClNlZQoKPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhbmRhcmRfc3RyZWFtcyI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">standard output</a> stream (<code>stdout</code>) by default. We can redirect this to a file in <a class="glossary-ref" data-glossary-term="bash" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Jhc2gnIHJvbGU9J3Rvb2x0aXAnPkEKCnBvcHVsYXIKClVuaXgKCnNoZWxsCgphbmQKCmNvbW1hbmQKCmxhbmd1YWdlCgp0aGF0CgppcwoKdXNlZAoKb24KCnRoZQoKS2xvbmUKCmNsdXN0ZXIuCgpTZWUKCjxhIGhyZWY9Imh0dHBzOi8vd3d3LmdudS5vcmcvc29mdHdhcmUvYmFzaC8iPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">bash</a> using the <code>&gt;</code> operator.</span>
</dd>
</dl>
<div class="callout callout-style-default callout-tip callout-titled" title="How to paste and save a file in the terminal">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How to paste and save a file in the terminal
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can use the <code>nano</code> command to create a new file and paste the contents of the file into the terminal. To do this, run <code>nano &lt;filename&gt;</code> in the terminal, paste the contents of the file into the terminal, and press <code>Ctrl+X</code> to exit. You will be asked if you want to save the file. Press <code>Y</code> to save the file and <code>Enter</code> to confirm the filename.</p>
</div>
</div>
<p>Now let’s run the script using Python 3.10 and Python 3.11. For the image, we will use the <code>python:3.10-slim</code> and <code>python:3.11-slim</code> images from the official <a href="https://hub.docker.com/_/python">Python images</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Tagged container releases">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tagged container releases
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>python:3.10-slim</code> and <code>python:3.11-slim</code> images are tagged with the version of Python they contain. This means that if you pull the <code>python:3.10-slim</code> image today, it will always contain Python 3.10, even if Python 3.11 is released tomorrow.</p>
<p><em>The <code>python:*-slim</code> images are designed to contain only the minimal set of packages required to run Python and are much smaller than the standard Python images (~45 MiB vs ~350 MiB).</em></p>
</div>
</div>
<p>We’ll use the <code>apptainer exec</code> command to run the script inside an Apptainer container:</p>
<div class="sourceCode" id="annotated-cell-6"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-1" class="code-annotation-target"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://python:3.10-slim python3 speedtest.py</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="1" data-code-annotation="1">The <code>apptainer exec</code> command runs a command inside an Apptainer container. The <code>docker://python:3.10-slim</code> argument tells Apptainer to use the <code>python:3.10-slim</code> image from the Docker registry. The <code>python3 ./speedtest.py</code> argument tells Apptainer to run the <code>python3</code> command inside the container and provide it with the argument <code>speedtest.py</code>.</span>
</dd>
</dl>
<p>You should see something like:</p>
<div class="sourceCode" id="annotated-cell-7"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-1" class="code-annotation-target"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Running</span> join_nums<span class="er">(</span><span class="kw">)</span> <span class="ex">1000*100</span> times on Python v3.10</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-2" class="code-annotation-target"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0.003154174002702348</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="1" data-code-annotation="1">This is printed to <a class="glossary-ref" data-glossary-term="stderr" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZGVycicgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKZXJyb3IKCnN0cmVhbSwKCjxjb2RlPnN0ZGVycjwvY29kZT4KLAoKaXMKCndoZXJlCgphCgpwcm9ncmFt4oCZcwoKZXJyb3IKCmFuZAoKZGlhZ25vc3RpYwoKbWVzc2FnZXMKCmFyZQoKd3JpdHRlbgoKdG8KCmJ5CgpkZWZhdWx0LgoKU2VlCgo8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TdGFuZGFyZF9zdHJlYW1zIj5oZXJlPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">stderr</a> because we used <code>print(..., file=sys.stderr)</code> in the script.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="2" data-code-annotation="2">This is printed to <a class="glossary-ref" data-glossary-term="stdout" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZG91dCcgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKb3V0cHV0CgpzdHJlYW0sCgo8Y29kZT5zdGRvdXQ8L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCm91dHB1dAoKaXMKCndyaXR0ZW4KCnRvCgpieQoKZGVmYXVsdC4KClNlZQoKPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhbmRhcmRfc3RyZWFtcyI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">stdout</a>.</span>
</dd>
</dl>
<p>It probably didn’t take very long to run the script. Let’s try running it again with larger values of <code>M</code> and <code>N</code>. We can set the values of <code>M</code> and <code>N</code> by setting them as <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variables</a> in the <a class="glossary-ref" data-glossary-term="bash" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Jhc2gnIHJvbGU9J3Rvb2x0aXAnPkEKCnBvcHVsYXIKClVuaXgKCnNoZWxsCgphbmQKCmNvbW1hbmQKCmxhbmd1YWdlCgp0aGF0CgppcwoKdXNlZAoKb24KCnRoZQoKS2xvbmUKCmNsdXN0ZXIuCgpTZWUKCjxhIGhyZWY9Imh0dHBzOi8vd3d3LmdudS5vcmcvc29mdHdhcmUvYmFzaC8iPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">bash</a> command prompt before running the script:</p>
<div class="sourceCode" id="annotated-cell-8"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-1" class="code-annotation-target"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">M</span><span class="op">=</span>1000 <span class="va">N</span><span class="op">=</span>100_000</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://python:3.10-slim python3 speedtest.py</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="1" data-code-annotation="1">The <code>export</code> command sets the values of the <code>M</code> and <code>N</code> <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variables</a> and makes them available to other programs like <code>apptainer</code>. We’re setting <code>N</code> to <code>100_000</code> instead of <code>100000</code> because underscores can be used in Python to make large numbers easier to read. This is a feature of Python, not the shell (which interprets <code>100_000</code> as just a string and not a number).</span>
</dd>
</dl>
<p>It should take a bit longer to run this time.</p>
<p>Now, let’s try running the script using Python 3.11:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://python:3.11-slim python3 speedtest.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We don’t need to set the values of <code>M</code> and <code>N</code> again because they are still set from the previous command via <code>export</code> (unless you closed your terminal window or logged out).</p>
<p>It probably took a bit less time to run the script this time.</p>
<p>Is Python 3.11 really faster than Python 3.10? Let’s find out by redirecting the output of the script to a file:</p>
<div class="sourceCode" id="annotated-cell-10"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-1" class="code-annotation-target"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://python:3.10-slim python3 speedtest.py <span class="op">&gt;</span> py3.10.txt</span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://python:3.11-slim python3 speedtest.py <span class="op">&gt;</span> py3.11.txt</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2">2</button><span id="annotated-cell-10-3" class="code-annotation-target"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> py3.10.txt py3.11.txt <span class="co"># show the results</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="1,2" data-code-annotation="1">In <a class="glossary-ref" data-glossary-term="bash" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Jhc2gnIHJvbGU9J3Rvb2x0aXAnPkEKCnBvcHVsYXIKClVuaXgKCnNoZWxsCgphbmQKCmNvbW1hbmQKCmxhbmd1YWdlCgp0aGF0CgppcwoKdXNlZAoKb24KCnRoZQoKS2xvbmUKCmNsdXN0ZXIuCgpTZWUKCjxhIGhyZWY9Imh0dHBzOi8vd3d3LmdudS5vcmcvc29mdHdhcmUvYmFzaC8iPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">bash</a>, the <code>&gt;</code> operator redirects the output of a command to a file. If the file already exists, it will be overwritten. If you want to append to an existing file instead, use the <code>&gt;&gt;</code> operator. These operators can be used with any command, not just <code>apptainer</code>. For example, <code>ls &gt; my_files.txt</code> will write the output of <code>ls</code> to the file <code>my_files.txt</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="3" data-code-annotation="2">The <code>cat</code> command prints the contents of a file to&gt; <tt><a class="glossary-ref" data-glossary-term="stdout" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZG91dCcgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKb3V0cHV0CgpzdHJlYW0sCgo8Y29kZT5zdGRvdXQ8L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCm91dHB1dAoKaXMKCndyaXR0ZW4KCnRvCgpieQoKZGVmYXVsdC4KClNlZQoKPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhbmRhcmRfc3RyZWFtcyI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">stdout</a></tt>. If you want to print the contents of multiple files, you can list them all as arguments to <code>cat</code>.</span>
</dd>
</dl>
<p>We see the results, but they’re not very easy to interpret. Let’s pipe the output to Python to calculate the speedup:</p>
<div class="sourceCode" id="annotated-cell-11"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1">1</button><span id="annotated-cell-11-1" class="code-annotation-target"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> py3.10.txt py3.11.txt <span class="kw">|</span> <span class="ex">apptainer</span> exec docker://python:3.11-slim python3 <span class="at">-c</span> <span class="st">'print(float(input())/float(input()))'</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="1" data-code-annotation="1">The <code>|</code> operator pipes the output of one command to the input of another. In this case, we are piping the output of <code>cat py3.10.txt py3.11.txt</code> to the input of <code>apptainer exec docker://python:3.11-slim python3 -c 'print(float(input())/float(input()))'</code>. The <code>-c</code> option of the <code>python3</code> command tells Python to run the code provided as an argument. The code <code>print(float(input())/float(input()))</code> reads two lines of input from <a class="glossary-ref" data-glossary-term="stdin" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZGluJyByb2xlPSd0b29sdGlwJz5UaGUKCnN0YW5kYXJkCgppbnB1dAoKc3RyZWFtLAoKPGNvZGU+c3RkaW48L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCmlucHV0CgppcwoKcmVhZAoKZnJvbQoKYnkKCmRlZmF1bHQuCgpTZWUKCjxhIGhyZWY9Imh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1N0YW5kYXJkX3N0cmVhbXMiPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">standard input</a>, converts them to floating point numbers, divides the first by the second, and prints the result.</span>
</dd>
</dl>
<p>In my case, Python 3.11 was about 1.3 times faster than Python 3.10. Not bad!</p>
<p>Here’s a demo of the above commands. Note that I used <code>M=200</code> and <code>N=50_000</code> instead of <code>M=1000</code> and <code>N=100_000</code> because it takes a long time to run the script with the larger values of <code>M</code> and <code>N</code>.</p>
<div id="apptainer-python-speedtest" class="cast">

</div>
</section>
<section id="writing-a-definition-file-to-build-a-custom-apptainer-image" class="level3">
<h3 class="anchored" data-anchor-id="writing-a-definition-file-to-build-a-custom-apptainer-image">Writing a definition file to build a custom Apptainer image</h3>
<p>What if we wanted to add a command-line interface to make it possible to run the script with different values of <code>M</code> and <code>N</code> without having to set them as <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variables</a>? A user might want to set the values of <code>M</code> and <code>N</code> as command-line arguments. Maybe they would also like to be able to specify the output file instead of redirecting the output to a file. And how about a progress bar? Users love progress bars!</p>
<p>This sounds like a tall order, but it’s quite easy to do in Python using the <a href="https://click.palletsprojects.com">click</a> package for Python. Here’s the new script:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>speedtest-cli.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-12" data-filename="speedtest-cli.py"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, sys, timeit</span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> click</span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-6"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the context for the command line interface and add the options:</span></span>
<span id="annotated-cell-12-7"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a><span class="at">@click.command</span>()</span>
<span id="annotated-cell-12-8"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a><span class="at">@click.option</span>(</span>
<span id="annotated-cell-12-9"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-n"</span>,  <span class="co"># The name of the option</span></span>
<span id="annotated-cell-12-10"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a>    envvar<span class="op">=</span><span class="st">"N"</span>,  <span class="co"># Use the environment variable `N` if it exists</span></span>
<span id="annotated-cell-12-11"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a>    default<span class="op">=</span><span class="dv">1000</span>,  <span class="co"># Default value if `N` is not set</span></span>
<span id="annotated-cell-12-12"><a href="#annotated-cell-12-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"How many numbers to join"</span>,  <span class="co"># Help text for the `-n` option</span></span>
<span id="annotated-cell-12-13"><a href="#annotated-cell-12-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>,  <span class="co"># Convert the value to an integer</span></span>
<span id="annotated-cell-12-14"><a href="#annotated-cell-12-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-12-15"><a href="#annotated-cell-12-15" aria-hidden="true" tabindex="-1"></a><span class="at">@click.option</span>(</span>
<span id="annotated-cell-12-16"><a href="#annotated-cell-12-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-m"</span>,</span>
<span id="annotated-cell-12-17"><a href="#annotated-cell-12-17" aria-hidden="true" tabindex="-1"></a>    envvar<span class="op">=</span><span class="st">"M"</span>,</span>
<span id="annotated-cell-12-18"><a href="#annotated-cell-12-18" aria-hidden="true" tabindex="-1"></a>    default<span class="op">=</span><span class="dv">100</span>,</span>
<span id="annotated-cell-12-19"><a href="#annotated-cell-12-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"How many times to run the test"</span>,</span>
<span id="annotated-cell-12-20"><a href="#annotated-cell-12-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>,</span>
<span id="annotated-cell-12-21"><a href="#annotated-cell-12-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-12-22"><a href="#annotated-cell-12-22" aria-hidden="true" tabindex="-1"></a><span class="at">@click.option</span>(</span>
<span id="annotated-cell-12-23"><a href="#annotated-cell-12-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--output"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1">1</button><span id="annotated-cell-12-24" class="code-annotation-target"><a href="#annotated-cell-12-24" aria-hidden="true" tabindex="-1"></a>    default<span class="op">=</span><span class="st">"/dev/stdout"</span>,  <span class="co"># Write the result to stdout by default</span></span>
<span id="annotated-cell-12-25"><a href="#annotated-cell-12-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"Path to the output file"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2">2</button><span id="annotated-cell-12-26" class="code-annotation-target"><a href="#annotated-cell-12-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span>click.Path(writable<span class="op">=</span><span class="va">True</span>, dir_okay<span class="op">=</span><span class="va">False</span>),</span>
<span id="annotated-cell-12-27"><a href="#annotated-cell-12-27" aria-hidden="true" tabindex="-1"></a>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="3">3</button><span id="annotated-cell-12-28" class="code-annotation-target"><a href="#annotated-cell-12-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> speedtest(m, n, output):</span>
<span id="annotated-cell-12-29"><a href="#annotated-cell-12-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run a speed test."""</span>  <span class="co"># Help text for the command</span></span>
<span id="annotated-cell-12-30"><a href="#annotated-cell-12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-31"><a href="#annotated-cell-12-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> join_nums():  <span class="co"># The function to test</span></span>
<span id="annotated-cell-12-32"><a href="#annotated-cell-12-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"-"</span>.join([<span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)])</span>
<span id="annotated-cell-12-33"><a href="#annotated-cell-12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-34"><a href="#annotated-cell-12-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Running join_nums() </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">*</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss"> times on Python v</span><span class="sc">{</span>sys<span class="sc">.</span>version_info<span class="sc">.</span>major<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>sys<span class="sc">.</span>version_info<span class="sc">.</span>minor<span class="sc">}</span><span class="ss">"</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="annotated-cell-12-35"><a href="#annotated-cell-12-35" aria-hidden="true" tabindex="-1"></a>    bar <span class="op">=</span> click.progressbar(  <span class="co"># Create a progress bar</span></span>
<span id="annotated-cell-12-36"><a href="#annotated-cell-12-36" aria-hidden="true" tabindex="-1"></a>        length<span class="op">=</span>n <span class="op">*</span> m,</span>
<span id="annotated-cell-12-37"><a href="#annotated-cell-12-37" aria-hidden="true" tabindex="-1"></a>        update_min_steps<span class="op">=</span>n,  <span class="co"># Update the progress bar every `n` steps</span></span>
<span id="annotated-cell-12-38"><a href="#annotated-cell-12-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span><span class="op">=</span>sys.stderr,  <span class="co"># Print the progress bar to stderr</span></span>
<span id="annotated-cell-12-39"><a href="#annotated-cell-12-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-12-40"><a href="#annotated-cell-12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-41"><a href="#annotated-cell-12-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> join_nums_progress():  <span class="co"># Wrap the function to add the progress bar</span></span>
<span id="annotated-cell-12-42"><a href="#annotated-cell-12-42" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> join_nums()</span>
<span id="annotated-cell-12-43"><a href="#annotated-cell-12-43" aria-hidden="true" tabindex="-1"></a>        bar.update(n)  <span class="co"># Increment the progress bar by `n` steps</span></span>
<span id="annotated-cell-12-44"><a href="#annotated-cell-12-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="annotated-cell-12-45"><a href="#annotated-cell-12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-46"><a href="#annotated-cell-12-46" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> timeit.timeit(join_nums_progress, number<span class="op">=</span>m)  <span class="co"># Run the test</span></span>
<span id="annotated-cell-12-47"><a href="#annotated-cell-12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-48"><a href="#annotated-cell-12-48" aria-hidden="true" tabindex="-1"></a>    bar.render_finish()  <span class="co"># Stop rendering the progress bar</span></span>
<span id="annotated-cell-12-49"><a href="#annotated-cell-12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-50"><a href="#annotated-cell-12-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output, <span class="st">"w"</span>) <span class="im">as</span> f:  <span class="co"># Open the output file for writing</span></span>
<span id="annotated-cell-12-51"><a href="#annotated-cell-12-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(result, <span class="bu">file</span><span class="op">=</span>f)  <span class="co"># Write the result to the output file</span></span>
<span id="annotated-cell-12-52"><a href="#annotated-cell-12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-53"><a href="#annotated-cell-12-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> output <span class="op">!=</span> <span class="st">"/dev/stdout"</span>:  <span class="co"># Show the output path if it's not stdout</span></span>
<span id="annotated-cell-12-54"><a href="#annotated-cell-12-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Result written to </span><span class="sc">{</span>output<span class="sc">}</span><span class="ss">"</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="annotated-cell-12-55"><a href="#annotated-cell-12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-56"><a href="#annotated-cell-12-56" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="4">4</button><span id="annotated-cell-12-57" class="code-annotation-target"><a href="#annotated-cell-12-57" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:  <span class="co"># Run the script if it's executed directly</span></span>
<span id="annotated-cell-12-58"><a href="#annotated-cell-12-58" aria-hidden="true" tabindex="-1"></a>    speedtest()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="24" data-code-annotation="1">We set the default value of <code>--output</code> to <code>/dev/stdout</code> so that the script will print the result to <tt><a class="glossary-ref" data-glossary-term="stdout" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZG91dCcgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKb3V0cHV0CgpzdHJlYW0sCgo8Y29kZT5zdGRvdXQ8L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCm91dHB1dAoKaXMKCndyaXR0ZW4KCnRvCgpieQoKZGVmYXVsdC4KClNlZQoKPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhbmRhcmRfc3RyZWFtcyI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">stdout</a></tt> by default.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="26" data-code-annotation="2"><code>click</code> provides a <a href="https://click.palletsprojects.com/en/8.1.x/api/#click.Path"><code>Path</code></a> type that can be used to validate paths. The <code>writable=True</code> option tells <code>click</code> that the path must be writable. The <code>dir_okay=False</code> option tells <code>click</code> that the path must not be a directory.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="28" data-code-annotation="3">The <code>@click.command()</code> <a href="https://docs.python.org/3.10/glossary.html#term-decorator">decorator</a> tells <code>click</code> that the first function definition that follows defines a command. The <code>@click.option()</code> decorators add options to the command-line interface. <code>click</code> passes the values of these options to the function using the names of the options (lowercased and with <code>-</code> replaced by <code>_</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="57" data-code-annotation="4">The <code>__name__ == "__main__"</code> check ensures that the script is only run if it is executed directly and not if it is imported as a module. This is useful if you want to use the script as a module in another script. We don’t <em>need</em> to do this here, but it’s a good habit to get into.</span>
</dd>
</dl>
<p>Now, let’s try running the script with <code>apptainer exec</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> exec docker://python:3.11-slim python3 speedtest-cli.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You probably got a <code>ModuleNotFoundError</code> because the <code>click</code> package is not installed in the <code>python:3.11-slim</code> image. If you know some Python, you might think, “I could probably fix this if I install the <code>click</code> module via <code>pip</code>.” And you would be right – if you were running the script in the version of Python that’s normally installed on your computer. But we’re running the script inside an Apptainer container, so we need to install the <code>click</code> module inside the container. Furthermore, we’re using <em>two</em> different versions of Python, so we need to install the <code>click</code> module in the containers for <em>both</em> versions.</p>
<p>We’ll solve this by writing an <a href="https://apptainer.org/docs/user/latest/definition_files.html">Apptainer definition file</a> to build a custom Apptainer image that contains the <code>click</code> module. Here’s the definition file:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>speedtest.def</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-14" data-filename="speedtest.def"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1">1</button><span id="annotated-cell-14-1" class="code-annotation-target"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Bootstrap:</span> docker <span class="co"># Where to get the base image from.</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2">2</button><span id="annotated-cell-14-2" class="code-annotation-target"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">From:</span> python:{{ PY_VERSION }}-slim <span class="co"># Which container to use as a base image.</span></span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="3">3</button><span id="annotated-cell-14-4" class="code-annotation-target"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">%arguments</span></span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The version of Python to use:</span></span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">PY_VERSION</span><span class="op">=</span>3.10</span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">%files</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="4">4</button><span id="annotated-cell-14-9" class="code-annotation-target"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">speedtest-cli.py</span> /opt/local/bin/speedtest <span class="co"># Copy the script to the container.</span></span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="5">5</button><span id="annotated-cell-14-11" class="code-annotation-target"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a><span class="ex">%post</span></span>
<span id="annotated-cell-14-12"><a href="#annotated-cell-14-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a virtual environment in /opt/venv to install our dependencies:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="6">6</button><span id="annotated-cell-14-13" class="code-annotation-target"><a href="#annotated-cell-14-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">/usr/local/bin/python</span> <span class="at">-m</span> venv /opt/venv</span>
<span id="annotated-cell-14-14"><a href="#annotated-cell-14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-15"><a href="#annotated-cell-14-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Install `click` and don't cache the downloaded files:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="7">7</button><span id="annotated-cell-14-16" class="code-annotation-target"><a href="#annotated-cell-14-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">/opt/venv/bin/pip</span> install <span class="at">--no-cache-dir</span> click</span>
<span id="annotated-cell-14-17"><a href="#annotated-cell-14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-18"><a href="#annotated-cell-14-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print a message to stderr to let the user know that the installation is done:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="8">8</button><span id="annotated-cell-14-19" class="code-annotation-target"><a href="#annotated-cell-14-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"</span><span class="va">$(</span><span class="ex">/opt/venv/bin/python3</span> <span class="at">--version</span><span class="va">)</span><span class="st">: Done installing dependencies."</span> <span class="op">&gt;&amp;</span><span class="dv">2</span></span>
<span id="annotated-cell-14-20"><a href="#annotated-cell-14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-21"><a href="#annotated-cell-14-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make the `speedtest` command executable:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="9">9</button><span id="annotated-cell-14-22" class="code-annotation-target"><a href="#annotated-cell-14-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">chmod</span> +x /opt/local/bin/speedtest</span>
<span id="annotated-cell-14-23"><a href="#annotated-cell-14-23" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="10">10</button><span id="annotated-cell-14-24" class="code-annotation-target"><a href="#annotated-cell-14-24" aria-hidden="true" tabindex="-1"></a><span class="ex">%environment</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="11">11</button><span id="annotated-cell-14-25" class="code-annotation-target"><a href="#annotated-cell-14-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">"/opt/local/bin:</span><span class="va">$PATH</span><span class="st">"</span> <span class="co"># Add the directory with the `speedtest` command to the PATH.</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="12">12</button><span id="annotated-cell-14-26" class="code-annotation-target"><a href="#annotated-cell-14-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">"/opt/venv/bin:</span><span class="va">$PATH</span><span class="st">"</span> <span class="co"># Add the virtual environment to the PATH.</span></span>
<span id="annotated-cell-14-27"><a href="#annotated-cell-14-27" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="13">13</button><span id="annotated-cell-14-28" class="code-annotation-target"><a href="#annotated-cell-14-28" aria-hidden="true" tabindex="-1"></a><span class="ex">%runscript</span></span>
<span id="annotated-cell-14-29"><a href="#annotated-cell-14-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run the Python script with the arguments passed to the container:</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="14">14</button><span id="annotated-cell-14-30" class="code-annotation-target"><a href="#annotated-cell-14-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">speedtest</span> <span class="st">"</span><span class="va">$@</span><span class="st">"</span></span>
<span id="annotated-cell-14-31"><a href="#annotated-cell-14-31" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="15">15</button><span id="annotated-cell-14-32" class="code-annotation-target"><a href="#annotated-cell-14-32" aria-hidden="true" tabindex="-1"></a><span class="ex">%test</span></span>
<span id="annotated-cell-14-33"><a href="#annotated-cell-14-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run the speedtest command to check if it works:</span></span>
<span id="annotated-cell-14-34"><a href="#annotated-cell-14-34" aria-hidden="true" tabindex="-1"></a>    <span class="ex">speedtest</span> <span class="at">-m</span> 2000 <span class="at">-n</span> 1000</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="1" data-code-annotation="1">Each definition file <a href="https://apptainer.org/docs/user/latest/definition_files.html#header">must start</a> with a <code>Bootstrap</code> line that tells Apptainer where to get the base image from. In this case, we’re using the <code>docker</code> bootstrap, which means that we’re getting the base image from the Docker registry.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="2" data-code-annotation="2">We’re using the <code>python:{{ PY_VERSION }}</code> image as the base image. The <code>{ PY_VERSION }</code> part refers to a <a href="https://apptainer.org/docs/user/latest/definition_files.html#template-variables">template variable</a> and will be replaced with the value of the <code>PY_VERSION</code> <a href="https://apptainer.org/docs/user/latest/definition_files.html#arguments">build argument</a> when we build the image. This means we can use the same definition file to build images for different versions of Python.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="4" data-code-annotation="3">The definition file is split into <a href="https://apptainer.org/docs/user/latest/definition_files.html#sections">sections</a>. The <a href="https://apptainer.org/docs/user/latest/definition_files.html#arguments"><code>%arguments</code></a> section defines the <a class="glossary-ref" data-glossary-term="build argument" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2J1aWxkIGFyZ3VtZW50JyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKY2FuCgpiZQoKc2V0CgpkdXJpbmcKCmJ1aWxkCgp0aW1lCgp3aXRoCgpBcHB0YWluZXIKCndpdGgKCnRoZQoKPGNvZGU+LS1idWlsZC1hcmc8L2NvZGU+CgpvcHRpb24uCgpTZWUKCnRoZQoKPGEKaHJlZj0iaHR0cHM6Ly9hcHB0YWluZXIub3JnL2RvY3MvdXNlci9tYWluL2RlZmluaXRpb25fZmlsZXMuaHRtbCNhcmd1bWVudHMiPkFwcHRhaW5lcgpkb2N1bWVudGF0aW9uPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">build arguments</a> for the image. We’re using the <code>PY_VERSION</code> argument to specify the version of Python to use, and we’re setting the default value to <code>3.10</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="9" data-code-annotation="4">The <a href="https://apptainer.org/docs/user/latest/definition_files.html#files"><code>%files</code></a> section defines the files to copy inside the container. We’re copying the <code>speedtest-cli.py</code> script to <code>/opt/local/bin/speedtest</code> in the container. /opt/local/bin is a good place to put scripts that you want to be able to run from anywhere in the container, but you should add the directory to the <code>PATH</code> environment variable if you want to be able to run the script without specifying the full path to the script. We’re removing the <code>.py</code> extension from the script name because we want to be able to run the script by typing <code>speedtest</code> instead of <code>speedtest-cli.py</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="11" data-code-annotation="5">The <a href="https://apptainer.org/docs/user/latest/definition_files.html#post"><code>%post</code></a> section defines the commands to run inside the container after the base image has been downloaded. This is where you should install any dependencies that your script needs.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="13" data-code-annotation="6">We’re using the <code>python -m venv</code> command to create a virtual environment in <code>/opt/venv</code>, which is where we will install the <code>click</code> module.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="16" data-code-annotation="7">We run <code>pip</code> from the virtual environment to install the <code>click</code> module. We use the <code>--no-cache-dir</code> option to tell <code>pip</code> not to cache the downloaded files. This is useful because we don’t need the downloaded files after we’ve installed the <code>click</code> module – otherwise, they would just take up space in the built image.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="19" data-code-annotation="8">We’re using the <code>echo</code> command to print a message to <a class="glossary-ref" data-glossary-term="stderr" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZGVycicgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKZXJyb3IKCnN0cmVhbSwKCjxjb2RlPnN0ZGVycjwvY29kZT4KLAoKaXMKCndoZXJlCgphCgpwcm9ncmFt4oCZcwoKZXJyb3IKCmFuZAoKZGlhZ25vc3RpYwoKbWVzc2FnZXMKCmFyZQoKd3JpdHRlbgoKdG8KCmJ5CgpkZWZhdWx0LgoKU2VlCgo8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TdGFuZGFyZF9zdHJlYW1zIj5oZXJlPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">stderr</a> to let the user know that the installation is done. We’re using the <code>&gt;&amp;2</code> operator to redirect the output of <code>echo</code> to <a class="glossary-ref" data-glossary-term="stderr" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZGVycicgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKZXJyb3IKCnN0cmVhbSwKCjxjb2RlPnN0ZGVycjwvY29kZT4KLAoKaXMKCndoZXJlCgphCgpwcm9ncmFt4oCZcwoKZXJyb3IKCmFuZAoKZGlhZ25vc3RpYwoKbWVzc2FnZXMKCmFyZQoKd3JpdHRlbgoKdG8KCmJ5CgpkZWZhdWx0LgoKU2VlCgo8YSBocmVmPSJodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TdGFuZGFyZF9zdHJlYW1zIj5oZXJlPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">stderr</a> instead of <a class="glossary-ref" data-glossary-term="stdout" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3N0ZG91dCcgcm9sZT0ndG9vbHRpcCc+VGhlCgpzdGFuZGFyZAoKb3V0cHV0CgpzdHJlYW0sCgo8Y29kZT5zdGRvdXQ8L2NvZGU+CiwKCmlzCgp3aGVyZQoKYQoKcHJvZ3JhbeKAmXMKCm91dHB1dAoKaXMKCndyaXR0ZW4KCnRvCgpieQoKZGVmYXVsdC4KClNlZQoKPGEgaHJlZj0iaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3RhbmRhcmRfc3RyZWFtcyI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">stdout</a>. The <code>$(...)</code> syntax runs the commands within and inserts the output into a string. In this case, we’re using it to insert the output of <code>python3 --version</code> into the string we’re about to print with <code>echo</code>. This helps the user know which version of Python the built image will contain.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="22" data-code-annotation="9">We’re using the <code>chmod</code> command to make the <code>speedtest</code> command executable – otherwise, we wouldn’t be able to run it without passing it to the <code>python3</code> command.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="24" data-code-annotation="10">The <a href="https://apptainer.org/docs/user/latest/definition_files.html#environment"><code>%environment</code></a> section defines the environment variables to set in the container. Note that the environment variables set in the <code>%environment</code> section are only set when the container is run. They are <em>not</em> set when the image is built, so they are not available in the <code>%post</code> section, even if you move the <code>%environment</code> section above the <code>%post</code> section.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="25" data-code-annotation="11">We’re prepending <code>/opt/local/bin</code> to the existing value of the <tt><a class="glossary-ref" data-glossary-term="path" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J3BhdGgnIHJvbGU9J3Rvb2x0aXAnPkFuCgplbnZpcm9ubWVudAoKdmFyaWFibGUKCnRoYXQKCmNvbnRhaW5zCgphCgpsaXN0CgpvZgoKZGlyZWN0b3JpZXMKCnRoYXQKCmFyZQoKc2VhcmNoZWQKCmZvcgoKZXhlY3V0YWJsZQoKcHJvZ3JhbXMuCgpTZWUKCjxhCmhyZWY9Imh0dHBzOi8vcHVicy5vcGVuZ3JvdXAub3JnL29ubGluZXB1YnMvMDAwMDk1Mzk5L2Jhc2VkZWZzL3hiZF9jaGFwMDguaHRtbCN0YWdfMDhfMDMiPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">PATH</a></tt> environment variable so that we can run the <code>speedtest</code> command from anywhere in the container. The <code>PATH</code> environment variable is used by the shell to find commands. If you want to be able to run a command without specifying the full path to the command, you need to add the directory containing the command to the <code>PATH</code> environment variable, separated by a colon (<code>:</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="26" data-code-annotation="12">Adding the <code>/opt/venv/bin</code> directory to the <code>PATH</code> environment variable makes it possible to run the <code>python</code> command from the virtual environment we created in the <code>%post</code> section. This is necessary because we installed the <code>click</code> module in the virtual environment, so we need to run the <code>python</code> command from the virtual environment to be able to import the <code>click</code> module.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="13">13</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="28" data-code-annotation="13">The <a href="https://apptainer.org/docs/user/latest/definition_files.html#runscript"><code>%runscript</code></a> section defines the command to run when the container is run. In this case, we’re running the <code>speedtest</code> command we installed in the <code>%post</code> section.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="14">14</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="30" data-code-annotation="14">We’re using the <a href="https://www.gnu.org/software/bash/manual/html_node/Special-Parameters.html#index-_0040"><code>$@</code></a> <em>special parameter</em> to pass all the arguments passed to the container to the <code>speedtest</code> command – for example, if you run <code>apptainer exec speedtest.sif --output output.txt</code>, the <code>speedtest</code> command will be run with the arguments <code>--output output.txt</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="15">15</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="32" data-code-annotation="15">The <a href="https://apptainer.org/docs/user/latest/definition_files.html#test"><code>%test</code></a> section defines the command to run when the image is built. In this case, we’re running the <code>speedtest</code> command to make sure that it works.</span>
</dd>
</dl>
<p>Now we can build the image using the <a href="https://apptainer.org/docs/user/latest/cli/apptainer_build.html"><code>apptainer build</code></a> command. The first argument is the name of the image to build. The second argument is the path to the definition file:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build speedtest-py3.10.sif speedtest.def</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It might take a little while to build the image. If everything goes according to plan, you should see the output of a test run at the end of the build process when the <code>%test</code> section is run.</p>
<p>When it’s done, the image will be saved as <code>speedtest-py3.10.sif</code> in the current directory. This image encapsulates the script and all its dependencies, so we can run it on any system that has Apptainer installed without having to worry about whether the system has a specific version of Python or the <code>click</code> module installed. Furthermore, because we defined a <code>%runscript</code> section in the definition file, we can run the script without having to specify the <code>python3</code> command.</p>
<p>To run the containerized script, we can run the <a href="https://apptainer.org/docs/user/latest/cli/apptainer_run.html"><code>apptainer run</code></a> command, which is similar to <a href="https://apptainer.org/docs/user/latest/cli/apptainer_exec.html"><code>apptainer exec</code></a> but launches the commands in the <code>%runscript</code> section of the definition file instead of the command specified as an argument:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.10.sif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see a progress bar and the result of the test.</p>
<p>Because the container image is <a class="glossary-ref" data-glossary-term="chmod" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2NobW9kJyByb2xlPSd0b29sdGlwJz5BCgpjb21tYW5kCgp0aGF0CgppcwoKdXNlZAoKdG8KCmNoYW5nZQoKdGhlCgpwZXJtaXNzaW9ucwoKb2YKCmEKCmZpbGUKCm9yCgpkaXJlY3RvcnksCgpvcgoKdG8KCm1hcmsKCmEKCmZpbGUKCmFzCgpleGVjdXRhYmxlCgpzbwoKdGhhdAoKaXQKCmNhbgoKYmUKCnJ1bi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9jb3JldXRpbHMvbWFudWFsL2h0bWxfbm9kZS9jaG1vZC1pbnZvY2F0aW9uLmh0bWwiPmhlcmU8L2E+Cgpmb3IKCm1vcmUKCmluZm9ybWF0aW9uLjwvZGl2Pg==" href="javascript:void(0);">marked</a> as an executable, we can also run it directly without having to specify the <code>apptainer</code> command (although it will still run using Apptainer):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./speedtest-py3.10.sif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Try it with some different values of <code>M</code> and <code>N</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.10.sif <span class="at">-m</span> 30_000 <span class="at">-n</span> 1000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now try specifying a different output file:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.10.sif <span class="at">--</span> <span class="at">-m</span> 30_000 <span class="at">-n</span> 1000 <span class="at">--output</span> py3.10.txt</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> py3.10.txt <span class="co"># Show the results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>How do we build the image for Python 3.11? We could copy the definition file and change <code>PY_VERSION</code> to <code>3.11</code>, but that would be a lot of work. Instead, we can use the <code>--build-arg</code> option of the <code>apptainer build</code> command to pass the value of <code>PY_VERSION</code> as a <a class="glossary-ref" data-glossary-term="build argument" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2J1aWxkIGFyZ3VtZW50JyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKY2FuCgpiZQoKc2V0CgpkdXJpbmcKCmJ1aWxkCgp0aW1lCgp3aXRoCgpBcHB0YWluZXIKCndpdGgKCnRoZQoKPGNvZGU+LS1idWlsZC1hcmc8L2NvZGU+CgpvcHRpb24uCgpTZWUKCnRoZQoKPGEKaHJlZj0iaHR0cHM6Ly9hcHB0YWluZXIub3JnL2RvY3MvdXNlci9tYWluL2RlZmluaXRpb25fZmlsZXMuaHRtbCNhcmd1bWVudHMiPkFwcHRhaW5lcgpkb2N1bWVudGF0aW9uPC9hPgoKZm9yCgptb3JlCgppbmZvcm1hdGlvbi48L2Rpdj4=" href="javascript:void(0);">build argument</a> to the definition file:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build <span class="at">--build-arg</span> PY_VERSION=3.11 speedtest-py3.11.sif speedtest.def</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we can run the script using the new image:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.11.sif <span class="at">-m</span> 30_000 <span class="at">-n</span> 1000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can still use the environment variables <code>M</code> and <code>N</code> to set the values of <code>m</code> and <code>n</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">M</span><span class="op">=</span>30_000 <span class="va">N</span><span class="op">=</span>1000</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.11.sif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This makes it easier to run both containers with the same values of <code>M</code> and <code>N</code> without having to specify them each time.</p>
<p>If we wanted to, we could even use <code>OUTPUT_FILE</code> to specify the output file instead of using the <code>--output</code> option because we let <code>click</code> know that <code>OUTPUT_FILE</code> is an alternative for the <code>--output</code> argument if there is no <code>--output</code> option:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">OUTPUT_FILE</span><span class="op">=</span>py3.11-2.txt</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.11.sif</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">unset</span> <span class="va">OUTPUT_FILE</span> <span class="co"># Unset the OUTPUT_FILE environment variable so that it doesn't affect the next command</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Because we specified the <code>%runscript</code> section in the definition file, we can also execute the script directly without having to specify the <code>apptainer</code> command:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./speedtest-py3.11.sif</span> <span class="at">-m</span> 30_000 <span class="at">-n</span> 1000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s recreate the comparison we did earlier:</p>
<div class="sourceCode" id="annotated-cell-25"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><span id="annotated-cell-25-1"><a href="#annotated-cell-25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">M</span><span class="op">=</span>1000 <span class="va">N</span><span class="op">=</span>100_000</span>
<span id="annotated-cell-25-2"><a href="#annotated-cell-25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.10.sif <span class="at">--output</span> py3.10.txt</span>
<span id="annotated-cell-25-3"><a href="#annotated-cell-25-3" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> run speedtest-py3.11.sif <span class="at">--output</span> py3.11.txt</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="1">1</button><span id="annotated-cell-25-4" class="code-annotation-target"><a href="#annotated-cell-25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> py3.10.txt py3.11.txt <span class="kw">|</span> <span class="ex">apptainer</span> exec speedtest-py3.10.sif python3 <span class="at">-c</span> <span class="st">'print(float(input())/float(input()))'</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-25" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="4" data-code-annotation="1">We’re using <code>apptainer exec</code> instead of <code>apptainer run</code> because we want to run the <code>python3</code> command instead of the command specified in the definition file.</span>
</dd>
</dl>
<p>Here’s a demo of the above commands:</p>
<div id="apptainer-python-speedtest-deffile" class="cast">

</div>
<!-- FIXME: Add another cast -->
</section>
<section id="clearing-the-apptainer-cache" class="level3">
<h3 class="anchored" data-anchor-id="clearing-the-apptainer-cache">Clearing the Apptainer cache</h3>
<p>Apptainer caches all the images it downloads in a cache directory to avoid downloading them again. The cache can get quite large, so it’s a good idea to clear it from time to time.</p>
<p>You can see the size of the cache directory by running:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> cache list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To clear the cache, run:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> cache clean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That should free up some space.</p>
</section>
<section id="changing-the-apptainer-cache-directory" class="level3">
<h3 class="anchored" data-anchor-id="changing-the-apptainer-cache-directory">Changing the Apptainer cache directory</h3>
<p>By default, Apptainer stores the cache in <code>~/.apptainer/cache</code>. This can be a problem if you have a small home directory (e.g., if you are using the default 10 GB quota on <a class="glossary-ref" data-glossary-term="klone" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2tsb25lJyByb2xlPSd0b29sdGlwJz5UaGUKCmxhdGVzdAoKZ2VuZXJhdGlvbgoKb2YKCnRoZQoKSHlhawoKc3VwZXJjb21wdXRlci4KClNlZQoKPGEgaHJlZj0iL2NvbXB1dGVfZG9jcy9kb2NzL3N0YXJ0L2ludHJvZHVjdGlvbi5odG1sIj5oZXJlPC9hPgoKZm9yCgpob3cKCnRvCgp1c2UKCml0LjwvZGl2Pg==" href="javascript:void(0);">Klone</a>). You can change the cache directory by setting the <code>APPTAINER_CACHE</code> <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variable</a>. For example, to set the cache directory to <code>/tmp/&lt;your-username&gt;/apptainer-cache</code>, you can use the <code>$USER</code> environment variable:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">APPTAINER_CACHE</span><span class="op">=</span><span class="st">"/tmp/</span><span class="va">$USER</span><span class="st">/apptainer-cache"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Apptainer will create the cache directory if it does not already exist.</p>
<p>You’ll need to set the <code>APPTAINER_CACHE</code> <a class="glossary-ref" data-glossary-term="environment variable" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Vudmlyb25tZW50IHZhcmlhYmxlJyByb2xlPSd0b29sdGlwJz5BCgp2YXJpYWJsZQoKdGhhdAoKaXMKCnVzZWQKCnRvCgpzdG9yZQoKaW5mb3JtYXRpb24KCmFib3V0Cgp0aGUKCmVudmlyb25tZW50Cgp0aGF0CgphCgpqb2IKCmlzCgpydW5uaW5nCgppbi4KClNlZQoKPGEKaHJlZj0iaHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvRW52aXJvbm1lbnQuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">environment variable</a> every time you want to use Apptainer, so it’s a good idea to add it to your <a class="glossary-ref" data-glossary-term="bashrc" data-glossary-def-base64="PGRpdiBjbGFzcz0nZ2xvc3NhcnktZGVmJyBkYXRhLWdsb3NzYXJ5LXRlcm09J2Jhc2hyYycgcm9sZT0ndG9vbHRpcCc+QQoKZmlsZQoKdGhhdAoKY29udGFpbnMKCmNvbW1hbmRzCgp0aGF0CgphcmUKCnJ1bgoKd2hlbgoKYQoKYmFzaAoKc2hlbGwKCmlzCgpzdGFydGVkLgoKU2VlCgo8YQpocmVmPSJodHRwczovL3d3dy5nbnUub3JnL3NvZnR3YXJlL2Jhc2gvbWFudWFsL2h0bWxfbm9kZS9CYXNoLVN0YXJ0dXAtRmlsZXMuaHRtbCI+aGVyZTwvYT4KCmZvcgoKbW9yZQoKaW5mb3JtYXRpb24uPC9kaXY+" href="javascript:void(0);">~/.bashrc</a> file so that it is always set when you log in.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("(^javascript:void[(]0[)])|(.*github[.]io[/].*[/]?compute_docs.*)");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../docs/compute/lmod.html" class="pagination-link" aria-label="Lmod">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Lmod</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../docs/software/index.html" class="pagination-link" aria-label="Software">
        <span class="nav-page-text">Software</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions"><ul><li><a href="https://github.com/uw-psych/compute_docs/blob/main/docs/compute/apptainer.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/uw-psych/compute_docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/uw-psych/compute_docs/edit/main/docs/compute/apptainer.qmd" class="toc-action"><i class="bi empty"></i>Edit this page</a></li></ul></div></div></div></footer><script src="../../_static/lib/asciinema-player.min.js"></script>
<script>
    term_font_family="'Cascadia Mono', monospace'"
    document.querySelectorAll('.cast').forEach((block) => {
        AsciinemaPlayer.create("../../_static/casts/" + block.id + ".cast", block, {
              terminalFontFamily: 'Iosevka Term Web, monospace',
               fit: false
        })
        });
</script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script>
  const refs = document.querySelectorAll(".glossary-ref");
  var activeRef, oldRef;

  refs.forEach((ref) => {
    //const def_string = atob(ref.getAttribute("data-glossary-def-base64"));
    const def_string = decodeURIComponent(escape(window.atob( ref.getAttribute("data-glossary-def-base64") )));
    let new_def = document.createElement("div");
    new_def.innerHTML = def_string;

    document.body.appendChild(new_def);

    const def = document.querySelector(
      "div[data-glossary-term='" + ref.getAttribute("data-glossary-term") + "']"
    );

    const popperInstance = Popper.createPopper(ref, def, {
      placement: "auto",
    });

    function show() {
      // Hide the old one if it exists
      if (activeRef != null) {
        oldRef = activeRef;
        oldRef.dispatchEvent(new Event("focusout"));
        oldRef = null; // Clear the old ref after hiding it
      }
      activeRef = ref; // Set the new active ref
      def.setAttribute("data-show", ""); // Show the definition by adding the data-show attribute

      // Enable the event listeners:
      popperInstance.setOptions((options) => ({
        ...options,
        modifiers: [
          ...options.modifiers,
          { name: "eventListeners", enabled: true },
        ],
      }));

      // Update its position
      popperInstance.update();
    }

    function hide() {
      // Only hide if the related target is null (i.e. the user clicked outside the popover):
      if ((event.relatedTarget === null || event.relatedTarget === undefined)) {
        def.removeAttribute("data-show");
        activeRef == null        // Disable the event listeners
        popperInstance.setOptions((options) => ({
          ...options,
          modifiers: [
            ...options.modifiers,
            { name: "eventListeners", enabled: false },
          ],
        }));
      } 
    }

    const showEvents = ["click", "touchstart"];
    const hideEvents = ["focusout"];

    showEvents.forEach((event) => {
      ref.addEventListener(event, show);
    });

    hideEvents.forEach((event) => {
      ref.addEventListener(event, hide);
    });
  });
</script>




</body></html>